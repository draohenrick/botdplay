<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Leads - Dplay Bot</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<style>
:root { --border-color: #dee2e6; --primary-color: #0d6efd; }
body { font-family: 'Poppins', sans-serif; }

/* Menu ativo igual ao dashboard */
.sidebar .nav-link.active { font-weight: 600; color: var(--primary-color); background-color: transparent; }
.sidebar .nav-link:hover { color: var(--primary-color); background-color: #e9ecef; }

.details-pre {
    background-color: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: .25rem;
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    font-size: 0.8rem;
}

.filter-bar {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 150px;
}

.card-body .btn { font-weight: 500; }
</style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky sidebar-sticky">
                <div class="text-center my-4">
                    <img id="user-logo" src="" alt="Logo do Cliente" style="display: none; max-width: 120px; max-height: 60px;">
                    <h6 id="user-logo-text" class="sidebar-heading px-3 text-dark"><span>Dplay Bot</span></h6>
                </div>
                <ul class="nav flex-column" style="height: calc(95% - 80px);">
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="instances.html">Conexões</a></li>
                    <li class="nav-item"><a class="nav-link" href="conversations.html">Conversas</a></li>
                    <li class="nav-item"><a class="nav-link active" href="leads.html">Leads</a></li>
                    <li class="nav-item"><a class="nav-link" href="services.html">Configurar Bot</a></li>
                    <li class="nav-item"><a class="nav-link" href="usuarios.html">Usuários</a></li>
                    <li class="nav-item mt-auto"><a class="nav-link" href="account.html">Minha Conta</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="page-header d-flex justify-content-between align-items-center mt-4">
                <h1>Leads Capturados</h1>
            </div>

            <div class="card mb-4">
                <div class="card-body filter-bar">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="instanceFilter" class="form-label fw-bold">Filtrar por Conexão</label>
                            <select id="instanceFilter" class="form-select"></select>
                        </div>
                        <div class="col-md-5">
                            <label for="searchFilter" class="form-label fw-bold">Buscar por Cliente ou Contato</label>
                            <input type="text" id="searchFilter" class="form-control" placeholder="Digite para buscar...">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-secondary w-100" id="resetFilters">Limpar Filtros</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="alertPlaceholder"></div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Resultados</span>
                    <span id="leadCount" class="badge bg-primary rounded-pill">0</span>
                </div>
                <div class="card-body">
                    <div id="leadsList" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/auth.js"></script>
<script>
protectPage();

window.addEventListener('DOMContentLoaded', () => {
    loadUserData();
    initializePage();
});

const leadsList = document.getElementById('leadsList');
const instanceFilter = document.getElementById('instanceFilter');
const searchFilter = document.getElementById('searchFilter');
const resetFiltersBtn = document.getElementById('resetFilters');
const leadCount = document.getElementById('leadCount');
let allLeads = [];

async function initializePage() {
    leadsList.innerHTML = `<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>`;
    try {
        const [instanceRes, leadsRes] = await Promise.all([
            fetch(`${BASE_URL}/api/instances`),
            fetch(`${BASE_URL}/api/leads`)
        ]);

        if (instanceRes.status === 401 || instanceRes.status === 403) return logout();

        const instances = await instanceRes.json();
        instanceFilter.innerHTML = '<option value="">Todas as Conexões</option>';
        instances.forEach(inst => instanceFilter.innerHTML += `<option value="${inst.id}">${inst.name}</option>`);

        if (!leadsRes.ok) throw new Error('Falha ao carregar leads do servidor.');
        allLeads = await leadsRes.json();

        applyFilters();

    } catch (e) {
        showAlert(e.message, 'danger');
        leadsList.innerHTML = `<p class="text-danger text-center">${e.message}</p>`;
    }
}

function applyFilters() {
    const instanceId = instanceFilter.value;
    const searchTerm = searchFilter.value.toLowerCase();
    let filteredLeads = allLeads;

    if (instanceId) filteredLeads = filteredLeads.filter(l => l.instanceId === parseInt(instanceId));
    if (searchTerm) filteredLeads = filteredLeads.filter(l =>
        (l.clientName && l.clientName.toLowerCase().includes(searchTerm)) ||
        (l.clientNumber && l.clientNumber.includes(searchTerm))
    );

    renderLeads(filteredLeads);
}

function renderLeads(leads) {
    leadCount.innerText = leads.length;
    if (!leads || leads.length === 0) {
        leadsList.innerHTML = '<div class="text-center p-5"><p class="text-muted">Nenhum lead encontrado com os filtros atuais.</p></div>';
        return;
    }

    let html = `<table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Contato</th>
                            <th>Origem (Bot)</th>
                            <th>Tipo</th>
                            <th>Detalhes</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>`;

    leads.forEach(lead => {
        const details = JSON.stringify(lead.details, null, 2);
        const contactNumber = lead.clientNumber.split('@')[0];
        html += `<tr>
            <td class="text-nowrap">${new Date(lead.timestamp).toLocaleString('pt-BR')}</td>
            <td>${lead.clientName || 'N/A'}</td>
            <td>${contactNumber}</td>
            <td><span class="badge bg-light text-dark">${lead.instanceName || 'N/A'}</span></td>
            <td><span class="badge bg-info text-dark">${lead.type || 'N/A'}</span></td>
            <td><pre class="details-pre"><code>${details}</code></pre></td>
            <td class="text-end">
                <a href="conversations.html?chatId=${lead.clientNumber}" class="btn btn-sm btn-outline-primary">Conversar</a>
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${contactNumber}')">Copiar</button>
            </td>
        </tr>`;
    });

    html += `</tbody></table>`;
    leadsList.innerHTML = html;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
        .then(() => showAlert('Número copiado!', 'success'))
        .catch(() => showAlert('Falha ao copiar número.', 'danger'));
}

instanceFilter.addEventListener('change', applyFilters);
searchFilter.addEventListener('input', applyFilters);
resetFiltersBtn.addEventListener('click', () => {
    instanceFilter.value = '';
    searchFilter.value = '';
    applyFilters();
});
</script>
</body>
</html>
