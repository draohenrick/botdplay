<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard - Dplay Bot</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #0d6efd;
        --border-color: #dee2e6;
    }
    body { font-family: 'Poppins', sans-serif; }
    /* Menu ativo igual ao código 2 */
    .sidebar .nav-link.active { 
        font-weight: 600; 
        color: var(--primary-color); 
        background-color: transparent; 
    }
    .sidebar .nav-link:hover { color: var(--primary-color); background-color: #e9ecef; }
    .badge-status { padding: .25em .5em; border-radius: .5rem; font-size: 0.75rem; color: #fff; }
    .bg-online { background-color: #198754; }
    .bg-offline { background-color: #dc3545; }
    .card-title { font-weight: 600; font-size: 1.25rem; }
</style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="position-sticky sidebar-sticky">
            <div class="text-center my-4">
                <img id="user-logo" src="" alt="Logo do Cliente" style="display: none; max-width: 120px; max-height: 60px;">
                <h6 id="user-logo-text" class="sidebar-heading px-3 text-dark"><span>Dplay Bot</span></h6>
            </div>
            <ul class="nav flex-column" style="height: calc(95% - 80px);">
                <li class="nav-item"><a class="nav-link active" href="index.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="instances.html">Conexões</a></li>
                <li class="nav-item"><a class="nav-link" href="conversations.html">Conversas</a></li>
                <li class="nav-item"><a class="nav-link" href="leads.html">Leads</a></li>
                <li class="nav-item"><a class="nav-link" href="services.html">Configurar Bot</a></li>
                <li class="nav-item"><a class="nav-link" href="usuarios.html">Usuários</a></li>
                <li class="nav-item mt-auto"><a class="nav-link" href="account.html">Minha Conta</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="page-header d-flex justify-content-between align-items-center my-3">
            <h1>Dashboard</h1>
        </div>

        <div id="alertPlaceholder"></div>

        <div class="row" id="stats-cards">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">...</h5>
                        <p class="card-text">Instâncias Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">...</h5>
                        <p class="card-text">Total de Leads</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Leads nos Últimos 7 Dias</div>
                    <div class="card-body">
                        <canvas id="leadsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Status das Instâncias</div>
                    <div class="card-body" id="instance-status-list">
                        <p class="text-center text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">Leads Recentes</div>
            <div class="card-body" id="recent-leads-list">
                <p class="text-center text-muted">Carregando...</p>
            </div>
        </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/auth.js"></script>
<script>
protectPage();

async function loadDashboard() {
    const statsContainer = document.getElementById('stats-cards');
    const instanceStatusList = document.getElementById('instance-status-list');
    const recentLeadsList = document.getElementById('recent-leads-list');

    try {
        const res = await fetch(`${BASE_URL}/api/dashboard/stats`);
        if (res.status === 401 || res.status === 403) return logout();
        if (!res.ok) throw new Error('Não foi possível carregar os dados do dashboard.');
        const stats = await res.json();

        statsContainer.innerHTML = `
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">${stats.onlineInstances} / ${stats.totalInstances}</h5>
                        <p class="card-text">Instâncias Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">${stats.totalLeads}</h5>
                        <p class="card-text">Total de Leads</p>
                    </div>
                </div>
            </div>
        `;

        if (stats.instanceStatus.length > 0) {
            let html = '<ul class="list-group list-group-flush">';
            stats.instanceStatus.forEach(inst => {
                const badgeClass = inst.status === 'online' ? 'bg-online' : 'bg-offline';
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">${inst.name} <span class="badge-status ${badgeClass}">${inst.status}</span></li>`;
            });
            html += '</ul>';
            instanceStatusList.innerHTML = html;
        } else {
            instanceStatusList.innerHTML = '<p class="text-center text-muted">Nenhuma instância cadastrada.</p>';
        }

        if (stats.recentLeads.length > 0) {
            let leadsHtml = '<ul class="list-group list-group-flush">';
            stats.recentLeads.forEach(lead => {
                leadsHtml += `<li class="list-group-item">${new Date(lead.timestamp).toLocaleDateString('pt-BR')} - <strong>${lead.clientName}</strong>: ${lead.type}</li>`;
            });
            leadsHtml += '</ul>';
            recentLeadsList.innerHTML = leadsHtml;
        } else {
            recentLeadsList.innerHTML = '<p class="text-center text-muted">Nenhum lead recente.</p>';
        }

        const ctx = document.getElementById('leadsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: stats.chartData.labels,
                datasets: [{
                    label: '# de Leads',
                    data: stats.chartData.data,
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                plugins: { legend: { display: false } }
            }
        });

    } catch(e) {
        instanceStatusList.innerHTML = '<p class="text-center text-muted">Não foi possível carregar os dados do dashboard.</p>';
        recentLeadsList.innerHTML = '<p class="text-center text-muted">Não foi possível carregar os leads.</p>';
        statsContainer.innerHTML = '';
        console.error(e);
    }
}

window.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
