<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Dplay Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script>const BACKEND_URL='https://botdplay.onrender.com';</script>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 bg-dark sidebar p-0">
      <div class="list-group list-group-flush">
        <a href="index.html" class="list-group-item list-group-item-action bg-dark text-white active">Dashboard</a>
        <a href="connections.html" class="list-group-item list-group-item-action bg-dark text-white">Conexões</a>
        <a href="conversations.html" class="list-group-item list-group-item-action bg-dark text-white">Conversas</a>
        <a href="leads.html" class="list-group-item list-group-item-action bg-dark text-white">Leads</a>
        <a href="bot-config.html" class="list-group-item list-group-item-action bg-dark text-white">Configurar Bot</a>
        <a href="account.html" class="list-group-item list-group-item-action bg-dark text-white">Minha Conta</a>
        <a href="#" id="logoutBtn" class="list-group-item list-group-item-action bg-dark text-white">Sair</a>
      </div>
    </nav>

    <!-- Main -->
    <main class="col-md-10 ms-sm-auto px-4 py-4">
      <h1>Dashboard</h1>
      <div class="row mt-4" id="kpiCards">
        <!-- Cards de KPIs -->
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <canvas id="chartConversations"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="chartLeads"></canvas>
        </div>
      </div>
      <div class="row mt-4" id="quickActions">
        <!-- Botões rápidos -->
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadDashboard() {
  const token = localStorage.getItem('token');
  if(!token) return window.location.href='index.html';

  try {
    const res = await fetch(`${BACKEND_URL}/api/dashboard`,{
      headers:{'Authorization':`Bearer ${token}`}
    });
    const data = await res.json();
    if(!data.success) return window.location.href='index.html';

    // Preencher KPIs
    const kpiCards = document.getElementById('kpiCards');
    kpiCards.innerHTML = `
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
          <div class="card-body">
            <h5 class="card-title">Conversas Ativas</h5>
            <p class="card-text">${data.kpis.activeConversations}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
          <div class="card-body">
            <h5 class="card-title">Leads Gerados</h5>
            <p class="card-text">${data.kpis.newLeads}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
          <div class="card-body">
            <h5 class="card-title">Conexões Ativas</h5>
            <p class="card-text">${data.kpis.activeConnections}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h5 class="card-title">Bot Online</h5>
            <p class="card-text">${data.kpis.botStatus ? 'Sim' : 'Não'}</p>
          </div>
        </div>
      </div>
    `;

    // Quick actions
    const quickActions = document.getElementById('quickActions');
    quickActions.innerHTML = `
      <button class="btn btn-primary me-2" onclick="window.location.href='conversations.html'">Nova Conversa</button>
      <button class="btn btn-warning" onclick="window.location.href='connections.html'">Adicionar Conexão</button>
    `;

    // Charts
    const ctxConversations = document.getElementById('chartConversations').getContext('2d');
    new Chart(ctxConversations,{
      type:'line',
      data:{
        labels:data.charts.conversations.labels,
        datasets:[{
          label:'Conversas',
          data:data.charts.conversations.values,
          backgroundColor:'rgba(255,102,0,0.2)',
          borderColor:'rgba(255,102,0,1)',
          borderWidth:2
        }]
      }
    });

    const ctxLeads = document.getElementById('chartLeads').getContext('2d');
    new Chart(ctxLeads,{
      type:'line',
      data:{
        labels:data.charts.leads.labels,
        datasets:[{
          label:'Leads',
          data:data.charts.leads.values,
          backgroundColor:'rgba(0,123,255,0.2)',
          borderColor:'rgba(0,123,255,1)',
          borderWidth:2
        }]
      }
    });

  } catch(e){
    console.error(e);
    alert('Erro ao carregar dashboard');
  }
}

document.getElementById('logoutBtn').addEventListener('click',()=>{
  localStorage.removeItem('token');
  window.location.href='index.html';
});

loadDashboard();
</script>
</body>
</html>
